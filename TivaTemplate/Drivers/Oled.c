#include "Oled.h"

const uint8_t OledFont[][8] =
    {
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x5F, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x07, 0x00, 0x07, 0x00, 0x00, 0x00},
        {0x00, 0x14, 0x7F, 0x14, 0x7F, 0x14, 0x00, 0x00},
        {0x00, 0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x00, 0x00},
        {0x00, 0x23, 0x13, 0x08, 0x64, 0x62, 0x00, 0x00},
        {0x00, 0x36, 0x49, 0x55, 0x22, 0x50, 0x00, 0x00},
        {0x00, 0x00, 0x05, 0x03, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x1C, 0x22, 0x41, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x41, 0x22, 0x1C, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x08, 0x2A, 0x1C, 0x2A, 0x08, 0x00, 0x00},
        {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00},
        {0x00, 0xA0, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00},
        {0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00},
        {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00, 0x00},
        {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00, 0x00, 0x00},
        {0x00, 0x62, 0x51, 0x49, 0x49, 0x46, 0x00, 0x00},
        {0x00, 0x22, 0x41, 0x49, 0x49, 0x36, 0x00, 0x00},
        {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10, 0x00, 0x00},
        {0x00, 0x27, 0x45, 0x45, 0x45, 0x39, 0x00, 0x00},
        {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30, 0x00, 0x00},
        {0x00, 0x01, 0x71, 0x09, 0x05, 0x03, 0x00, 0x00},
        {0x00, 0x36, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00},
        {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E, 0x00, 0x00},
        {0x00, 0x00, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0xAC, 0x6C, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x00},
        {0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x00},
        {0x00, 0x41, 0x22, 0x14, 0x08, 0x00, 0x00, 0x00},
        {0x00, 0x02, 0x01, 0x51, 0x09, 0x06, 0x00, 0x00},
        {0x00, 0x32, 0x49, 0x79, 0x41, 0x3E, 0x00, 0x00},
        {0x00, 0x7E, 0x09, 0x09, 0x09, 0x7E, 0x00, 0x00},
        {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00},
        {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22, 0x00, 0x00},
        {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00, 0x00},
        {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00},
        {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01, 0x00, 0x00},
        {0x00, 0x3E, 0x41, 0x41, 0x51, 0x72, 0x00, 0x00},
        {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00, 0x00},
        {0x00, 0x41, 0x7F, 0x41, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01, 0x00, 0x00},
        {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00},
        {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00},
        {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00, 0x00},
        {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00, 0x00},
        {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00, 0x00},
        {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06, 0x00, 0x00},
        {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E, 0x00, 0x00},
        {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46, 0x00, 0x00},
        {0x00, 0x26, 0x49, 0x49, 0x49, 0x32, 0x00, 0x00},
        {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01, 0x00, 0x00},
        {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00, 0x00},
        {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00, 0x00},
        {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F, 0x00, 0x00},
        {0x00, 0x63, 0x14, 0x08, 0x14, 0x63, 0x00, 0x00},
        {0x00, 0x03, 0x04, 0x78, 0x04, 0x03, 0x00, 0x00},
        {0x00, 0x61, 0x51, 0x49, 0x45, 0x43, 0x00, 0x00},
        {0x00, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00},
        {0x00, 0x41, 0x41, 0x7F, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x00},
        {0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00},
        {0x00, 0x01, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x20, 0x54, 0x54, 0x54, 0x78, 0x00, 0x00},
        {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38, 0x00, 0x00},
        {0x00, 0x38, 0x44, 0x44, 0x28, 0x00, 0x00, 0x00},
        {0x00, 0x38, 0x44, 0x44, 0x48, 0x7F, 0x00, 0x00},
        {0x00, 0x38, 0x54, 0x54, 0x54, 0x18, 0x00, 0x00},
        {0x00, 0x08, 0x7E, 0x09, 0x02, 0x00, 0x00, 0x00},
        {0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C, 0x00, 0x00},
        {0x00, 0x7F, 0x08, 0x04, 0x04, 0x78, 0x00, 0x00},
        {0x00, 0x00, 0x7D, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x80, 0x84, 0x7D, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00},
        {0x00, 0x41, 0x7F, 0x40, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x7C, 0x04, 0x18, 0x04, 0x78, 0x00, 0x00},
        {0x00, 0x7C, 0x08, 0x04, 0x7C, 0x00, 0x00, 0x00},
        {0x00, 0x38, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00},
        {0x00, 0xFC, 0x24, 0x24, 0x18, 0x00, 0x00, 0x00},
        {0x00, 0x18, 0x24, 0x24, 0xFC, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x7C, 0x08, 0x04, 0x00, 0x00, 0x00},
        {0x00, 0x48, 0x54, 0x54, 0x24, 0x00, 0x00, 0x00},
        {0x00, 0x04, 0x7F, 0x44, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x3C, 0x40, 0x40, 0x7C, 0x00, 0x00, 0x00},
        {0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00, 0x00},
        {0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00, 0x00},
        {0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00},
        {0x00, 0x1C, 0xA0, 0xA0, 0x7C, 0x00, 0x00, 0x00},
        {0x00, 0x44, 0x64, 0x54, 0x4C, 0x44, 0x00, 0x00},
        {0x00, 0x08, 0x36, 0x41, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x41, 0x36, 0x08, 0x00, 0x00, 0x00, 0x00},
        {0x00, 0x02, 0x01, 0x01, 0x02, 0x01, 0x00, 0x00},
        {0x00, 0x02, 0x05, 0x05, 0x02, 0x00, 0x00, 0x00},
};

void initOled(void)
{
    // enable i2c0 module
    SysCtlPeripheralEnable(SYSCTL_PERIPH_I2C3);

    // reset module
    // SysCtlPeripheralReset(SYSCTL_PERIPH_I2C3);

    // enable GPIO that contains I2C0
    SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOD);

    // Configure the pin muxing for I2C0 functions on port B2 and B3.
    GPIOPinConfigure(GPIO_PD0_I2C3SCL);
    GPIOPinConfigure(GPIO_PD1_I2C3SDA);

    // Select the I2C function for these pins.
    GPIOPinTypeI2CSCL(GPIO_PORTD_BASE, GPIO_PIN_0);
    GPIOPinTypeI2C(GPIO_PORTD_BASE, GPIO_PIN_1);

    I2CMasterInitExpClk(I2C3_BASE, SysCtlClockGet(), false);

    // clear I2C FIFOs
    HWREG(I2C3_BASE + I2C_O_FIFOCTL) = 80008000;

    sendOledCommand(OLED_DISPLAYOFF);         // 0xAE
    sendOledCommand(OLED_SETDISPLAYCLOCKDIV); // 0xD5
    sendOledCommand(0x80);                    // the suggested ratio 0x80
    sendOledCommand(OLED_SETMULTIPLEX);       // 0xA8
    sendOledCommand(0x1F);
    sendOledCommand(OLED_SETDISPLAYOFFSET);   // 0xD3
    sendOledCommand(0x0);                     // no offset
    sendOledCommand(OLED_SETSTARTLINE | 0x0); // line #0
    sendOledCommand(OLED_CHARGEPUMP);         // 0x8D
    sendOledCommand(0xAF);
    sendOledCommand(OLED_MEMORYMODE); // 0x20
    sendOledCommand(0x00);            // 0x0 act like ks0108
    sendOledCommand(OLED_SEGREMAP | 0x1);
    sendOledCommand(OLED_COMSCANDEC);
    sendOledCommand(OLED_SETCOMPINS); // 0xDA
    sendOledCommand(0x02);
    sendOledCommand(OLED_SETCONTRAST); // 0x81
    sendOledCommand(0x8F);
    sendOledCommand(OLED_SETPRECHARGE); // 0xd9
    sendOledCommand(0xF1);
    sendOledCommand(OLED_SETVCOMDETECT); // 0xDB
    sendOledCommand(0x40);
    sendOledCommand(OLED_DISPLAYALLON_RESUME); // 0xA4
    sendOledCommand(OLED_NORMALDISPLAY);       // 0xA6
    sendOledCommand(OLED_DISPLAYON);           //--turn on oled panel
}

void sendOledCommand(uint8_t cmd)
{
    uint8_t control = 0x00;
    char arr[2] = {control, cmd};
    sendI2CMultipleBytes(slaveAddress, 2, arr);
}

void sendI2CMultipleBytes(uint8_t slave_addr, uint8_t numOfBytes, char by[])
{
    uint8_t i;
    // Tell the master module what address it will place on the bus when
    // communicating with the slave.
    I2CMasterSlaveAddrSet(I2C3_BASE, slave_addr, false);

    // put the data to be sent in the FIFO
    I2CMasterDataPut(I2C3_BASE, by[0]);

    // Initialize sending data from the MCU
    I2CMasterControl(I2C3_BASE, I2C_MASTER_CMD_BURST_SEND_START);

    // wait while MCU is done transferring
    while (I2CMasterBusy(I2C3_BASE))
        ;
    for (i = 1; i < numOfBytes - 1; i++)
    {
        // put next piece of data into I2C FIFO
        I2CMasterDataPut(I2C3_BASE, by[i]);
        // send next data that was just placed into FIFO
        I2CMasterControl(I2C3_BASE, I2C_MASTER_CMD_BURST_SEND_CONT);

        // Wait until MCU is done transferring.
        while (I2CMasterBusy(I2C3_BASE))
            ;
    }
    // put last byte of data
    I2CMasterDataPut(I2C3_BASE, by[numOfBytes - 1]);
    // send next data that was just placed into FIFO
    I2CMasterControl(I2C3_BASE, I2C_MASTER_CMD_BURST_SEND_FINISH);
    // Wait until MCU is done transferring.
    while (I2CMasterBusy(I2C3_BASE))
        ;
}

void setOledCursor(unsigned char Row, unsigned char Column)
{
    sendOledCommand(0xB0 + Row);
    sendOledCommand(0x00 + (8 * Column & 0x0F));
    sendOledCommand(0x10 + ((8 * Column >> 4) & 0x0F));
}

void putCharOnOled(char ch)
{
    if ((ch < 32) || (ch > 127))
    {
        ch = ' ';
    }

    const uint8_t *base = &OledFont[ch - 32][0];

    uint8_t bytes[9];
    bytes[0] = 0x40;
    memmove(bytes + 1, base, 8);

    sendI2CMultipleBytes(slaveAddress, 9, bytes);
}

void clearOled()
{
    uint16_t row, col;
    for (row = 0; row < 4; row++)
    {
        for (col = 0; col < 16; col++)
        {
            setOledCursor(row, col);
            putCharOnOled(' ');
        }
    }
}

void showStringOnOled(char *s)
{
    while (*s)
        putCharOnOled(*s++);
}
